<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milch Experience - Mobile</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: black;
        }

        #playerContainer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .square {
            position: relative;
            background: url("https://i.postimg.cc/9MRsCJQ0/image.png") center center no-repeat;
            background-size: cover;
            transition: transform 0.3s ease, z-index 0.3s ease;
            overflow: hidden;
        }

        .square.tapped {
            transform: scale(1.04);
            z-index: 2;
        }

        .square.expanded {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: none;
            z-index: 999;
        }

        .square.expanded~.square {
            z-index: 1;
        }

        .square video {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            object-fit: cover;
        }

        #seekBar {
            display: none;
            width: 80%;
            margin: 0 auto;
            position: absolute;
            left: 10%;
            bottom: 10px;
        }

        .square.expanded.playing~#seekBar {
            display: block;
        }

        #controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            z-index: 3;
        }

        #seekBar::-webkit-slider-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="playerContainer">
        <div class="square" data-squareid="1">
            <video id="intro1" playsinline
                src="https://link.storjshare.io/s/jvsf3jhukg6dbgqlq5e6qauwchbq/music/video-output-55ABDD3F-533B-4378-ABFF-A76FA4631505.mp4?download=1"></video>
            <video id="loop1" playsinline loop muted
                src="https://link.storjshare.io/s/jvjwzyepdwe2xfuolfdq2kqdcp7a/music/milchloop.MP4?download=1"></video>
        </div>
        <div class="square" data-squareid="2">
            <video id="intro2" playsinline
                src="https://link.storjshare.io/s/jvsf3jhukg6dbgqlq5e6qauwchbq/music/video-output-55ABDD3F-533B-4378-ABFF-A76FA4631505.mp4?download=1"></video>
            <video id="loop2" playsinline loop muted
                src="https://link.storjshare.io/s/jvjwzyepdwe2xfuolfdq2kqdcp7a/music/milchloop.MP4?download=1"></video>
        </div>
        <div class="square" data-squareid="3">
            <video id="intro3" playsinline
                src="https://link.storjshare.io/s/jvsf3jhukg6dbgqlq5e6qauwchbq/music/video-output-55ABDD3F-533B-4378-ABFF-A76FA4631505.mp4?download=1"></video>
            <video id="loop3" playsinline loop muted
                src="https://link.storjshare.io/s/jvjwzyepdwe2xfuolfdq2kqdcp7a/music/milchloop.MP4?download=1"></video>
        </div>
        <div class="square" data-squareid="4">
            <video id="intro4" playsinline
                src="https://link.storjshare.io/s/jvsf3jhukg6dbgqlq5e6qauwchbq/music/video-output-55ABDD3F-533B-4378-ABFF-A76FA4631505.mp4?download=1"></video>
            <video id="loop4" playsinline loop muted
                src="https://link.storjshare.io/s/jvjwzyepdwe2xfuolfdq2kqdcp7a/music/milchloop.MP4?download=1"></video>
        </div>

        <div id="controls">
            <input id="seekBar" type="range" min="0" max="100" value="0">
        </div>

        <audio id="audio">
            <source src="https://link.storjshare.io/s/jvvuzllnvz7yqfsylqn5xeknupga/music/f.flac?download=1"
                type="audio/flac">
            Your browser does not support the audio tag.
        </audio>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const squares = document.querySelectorAll('.square');
            const audio = document.getElementById('audio');
            const seekBar = document.getElementById('seekBar');

            // We'll track a 'state' per square:
            //  0 => initial (frame image only)
            //  1 => intro displayed behind frame (playing in loop)
            //  2 => loop video + music in full page
            // We'll also track lastTap to detect double taps

            function getSquareState(sq) {
                return parseInt(sq.dataset.state || "0", 10);
            }
            function setSquareState(sq, st) {
                sq.dataset.state = st;
            }

            let currentSquare = null;
            let isIntroPlaying = false;

            function resetSquareVideos(sq) {
                const intro = sq.querySelector('video:first-of-type');
                const loop = sq.querySelector('video:last-of-type');
                intro.pause();
                intro.currentTime = 0;
                loop.pause();
                loop.currentTime = 0;
                sq.classList.remove('playing');
                setSquareState(sq, 0);
                intro.style.opacity = '1';
                loop.style.opacity = '0';
            }

            function playIntroThenLoop(sq) {
                const intro = sq.querySelector('video:first-of-type');
                const loop = sq.querySelector('video:last-of-type');

                isIntroPlaying = true;
                audio.play();
                intro.play();

                // Because user wants the intro in a loop behind frame image:
                intro.loop = true;
                intro.onended = null;
            }

            function switchToLoop(sq) {
                const intro = sq.querySelector('video:first-of-type');
                const loop = sq.querySelector('video:last-of-type');
                intro.style.opacity = '0';
                loop.style.opacity = '1';
                loop.play();
                audio.play();
                isIntroPlaying = false;
            }

            function syncMedia() {
                const duration = audio.duration;
                if (!duration) return;
                const currentTime = audio.currentTime;
                seekBar.value = (currentTime / duration) * 100;
            }

            // We'll detect double taps by timing consecutive taps
            function onSquareTap(sq) {
                const now = Date.now();
                const lastTap = parseInt(sq.dataset.lastTap || "0", 10);
                sq.dataset.lastTap = now.toString();
                const gap = now - lastTap;

                if (gap < 300) {
                    // Double tap => reset
                    resetSquareVideos(sq);
                    sq.classList.remove('tapped', 'expanded', 'playing');
                    audio.pause();
                    audio.currentTime = 0;
                    return;
                }

                const state = getSquareState(sq);
                const intro = sq.querySelector('video:first-of-type');
                const loop = sq.querySelector('video:last-of-type');

                // If we're in initial state => 0 => play intro behind frame image
                if (state === 0) {
                    squares.forEach(other => {
                        if (other !== sq) {
                            resetSquareVideos(other);
                            other.classList.remove('tapped', 'expanded', 'playing');
                        }
                    });
                    sq.classList.add('tapped'); // small scale
                    setSquareState(sq, 1);
                    intro.style.opacity = '1';  // behind frame
                    loop.style.opacity = '0';
                    playIntroThenLoop(sq);
                    return;
                }

                // If we're in state 1 => switch to loop
                if (state === 1) {
                    squares.forEach(other => {
                        if (other !== sq) {
                            resetSquareVideos(other);
                            other.classList.remove('tapped', 'expanded', 'playing');
                        }
                    });
                    // Expand to edges
                    sq.classList.add('expanded', 'playing');
                    currentSquare = sq;
                    setSquareState(sq, 2);
                    switchToLoop(sq);
                    return;
                }

                // If in state 2 => single tap toggles play/pause of loop + audio
                if (state === 2) {
                    if (audio.paused) {
                        audio.play();
                        loop.play();
                    } else {
                        audio.pause();
                        loop.pause();
                    }
                }
            }

            seekBar.addEventListener('input', () => {
                const seekTime = (seekBar.value / 100) * audio.duration;
                audio.currentTime = seekTime;
                syncMedia();
            });

            audio.addEventListener('timeupdate', syncMedia);

            // Attach the tap handler to each square
            squares.forEach(sq => {
                // Ensure each intro video is paused at first frame on load
                const intro = sq.querySelector("video:first-of-type");
                const loop = sq.querySelector("video:last-of-type");
                intro.pause();
                intro.currentTime = 0;
                intro.load();     // Ensures the first frame is visible
                // Keep intro muted so it can auto-play with user tap
                intro.muted = true;

                loop.pause();
                loop.currentTime = 0;
                loop.load();

                sq.addEventListener('click', () => onSquareTap(sq));
                setSquareState(sq, 0);
            });
        });
    </script>
</body>

</html>